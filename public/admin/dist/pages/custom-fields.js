function get_rules_json(){var e=[];$(".custom-fields-rules .line-group-container .line-group").each(function(t,a){var l=$(this),i={};i.field_relation=l.attr("data-rel"),i.field_options=[];var n=l.find(".rules-b-group select:not(.hidden)");n.each(function(e,t){var a=$(this),l={};l.rel_name=a.attr("data-rel"),l.rel_value=a.val(),l.rel_type=a.closest(".rules-b-group").prev(".rule-type").val(),i.field_options.push(l)}),e.push(i)}),$("#custom_fields_rules").html(JSON.stringify(e)),$("#custom_fields_rules").val(JSON.stringify(e))}function reload_order_numb(e){e.each(function(e,t){var a=$(this),l=e+1;a.attr("data-position",l)})}function my_custom_json_output(e,t){var a=returned_json(e,t,!1);return a}function returned_json(e,t,a){var l=[];return e.each(function(e,i){var n=$(this),r={};r.id=n.data("id"),r.instructions=n.data("instructions"),r.name=n.data("name"),r.options=n.data("options"),r.title=n.data("title"),r.type=n.data("type");var o=n.find('> .item-details > .options > div[data-option="repeater"] > .col-xs-9 > .add-new-field > .sortable-wrapper > li');if(t===!0&&(r.repeateritems=[],o.length>0)){var s=returned_json(o,!0,r.repeateritems);0!=s&&r.repeateritems.push(s)}"object"==typeof a?a.push(r):l.push(r)}),"object"==typeof a?0:l}function init_options(){var e={defaultvalue:"",placeholdertext:"",defaultvaluetextarea:"",wyswygtoolbar:"",selectchoices:"",buttonlabel:""};$(".sortable-wrapper > li").data("options",e),$(".item-details > .options input, .item-details > .options select, .item-details > .options textarea").each(function(e,t){var a=$(this).closest(".options"),l={defaultvalue:"",placeholdertext:"",defaultvaluetextarea:"",wyswygtoolbar:"",selectchoices:"",buttonlabel:""},i=a.find(' > [data-option="defaultvalue"]');i.length>0&&(l.defaultvalue=i.find("input").val());var n=a.find(' > [data-option="placeholdertext"]');n.length>0&&(l.placeholdertext=n.find("input").val());var r=a.find(' > [data-option="defaultvaluetextarea"]');r.length>0&&(l.defaultvaluetextarea=r.find("textarea").val());var o=a.find(' > [data-option="wyswygtoolbar"]');o.length>0&&(l.wyswygtoolbar=o.find('input[type="radio"]:checked').val());var s=a.find(' > [data-option="selectchoices"]');s.length>0&&(l.selectchoices=s.find("textarea").val());var d=a.find(' > [data-option="buttonlabel"]');d.length>0&&(l.buttonlabel=d.find("input").val());var u=a.closest("li");u.data("options",l),u.attr("data-options",JSON.stringify(l))})}$(window).load(function(){function e(e,t){var a=$("#_new-field-source_template").html();return t&&(a=a.replace('<optgroup label="Other"><option value="repeater">Repeater</option></optgroup>',"")),a=a.replace(/___options___/gi,i("text"))}var t=$("body"),a=0;$("#_repeater_template").html();t.on("click","a.show-item-details",function(e){e.preventDefault();var t=$(this).closest("li");$(this).toggleClass("active"),t.toggleClass("active")});var l={repeater:$("#_options-repeater_template").html(),defaultvalue:$("#_options-defaultvalue_template").html(),defaultvaluetextarea:$("#_options-defaultvaluetextarea_template").html(),placeholdertext:$("#_options-placeholdertext_template").html(),wyswygtoolbar:$("#_options-wyswygtoolbar_template").html(),selectchoices:$("#_options-selectchoices_template").html(),buttonlabel:$("#_options-buttonlabel_template").html()},i=function(e){var t="";switch(e){case"text":t+=l.defaultvalue+l.placeholdertext;break;case"textarea":t+=l.defaultvaluetextarea+l.placeholdertext;break;case"number":t+=l.defaultvaluetextarea+l.placeholdertext;break;case"wyswyg":t+=l.defaultvaluetextarea+l.placeholdertext+l.wyswygtoolbar;break;case"image":return"";case"file":return"";case"select":t+=l.selectchoices+l.defaultvalue;break;case"checkbox":t+=l.selectchoices+l.defaultvalue;break;case"radio":t+=l.selectchoices+l.defaultvalue;break;case"repeater":t+=l.repeater+l.buttonlabel;break;case"email":return i("text");case"password":return i("text")}return t};t.on("change",".change-field-type",function(e){e.preventDefault();var t=$(this),a=t.parent().parent(),l=a.find("~ .options");l.html(i(t.val())),App.initUniform()}),t.on("click",".btn-add-field",function(t){t.preventDefault();var l=$(this),i="";a++;var n=l.closest(".add-new-field").find("> .sortable-wrapper");i="repeater"==l.attr("href")?e(a,!0):e(a,!1),n.append(i),reload_order_numb(n.find("> li")),App.initUniform()});var n=[];$("#deleted_items").val(""),t.on("click",".btn-remove",function(e){e.preventDefault();var t=$(this).closest("li"),a=t.parent();n.push(t.attr("data-id")),t.animate({top:-60,left:60,opacity:.3},300,function(){t.remove(),reload_order_numb(a.find("> li")),$("#deleted_items").val(window.JSON.stringify(n))})}),t.on("click",".btn-close-field",function(e){e.preventDefault();var t=$(this).closest("li");t.removeClass("active"),t.find("a.show-item-details").removeClass("active")}),t.on("change",".item-details > .line input, .item-details > .line select, .item-details > .line textarea",function(e){e.preventDefault();var t=$(this).closest(".line"),a=t.closest("li");a.data(t.attr("data-option"),$(this).val()),a.attr("data-"+t.attr("data-option"),$(this).val()),a.find("> .field-column .field-label").html(a.find('> .item-details > [data-option="title"] input').val()),a.find("> .field-column .field-name").html(a.find('> .item-details > [data-option="name"] input').val()),a.find("> .field-column .field-type").html(a.find('> .item-details > [data-option="type"] select').val())}),t.on("change",".rule-line select.rule-a",function(e){e.preventDefault();var t=$(this),a=t.closest(".rule-line");a.find(".rules-b-group select").addClass("hidden"),a.find('.rules-b-group select[data-rel="'+t.val()+'"]').removeClass("hidden")}),$(".rule-line select.rule-a").trigger("change"),t.on("click",".location-add-rule",function(e){e.preventDefault();var t="",a=$(this),l=a.closest(".rule-line");a.hasClass("location-add-rule-and")?(t+='<div class="line rule-line rule-and">',t+=l.html(),t+="</div>",l.parent().append(t)):(l=a.parent().parent(),t+='<div class="line-group or-group" data-text="Or" data-rel="or"><div class="line rule-line rule-and">',t+=l.find("> .line-group-container > .line-group > .rule-line:first-child").html(),t+="</div></div>",$(".line-group-container").append(t)),$(".rule-line select.rule-a").trigger("change")}),t.on("click",".remove-rule-line",function(e){e.preventDefault();var t=$(this).closest(".rule-line");if(1!=t.parent().hasClass("and-group")){var a=!1;1==t.parent().find("> .rule-line").length&&(a=!0),t.animate({opacity:.3},300,function(){a?t.parent().remove():t.remove()})}else 1!=t.is(":first-child")&&t.animate({opacity:.3},300,function(){t.remove()})});var r=r=jQuery.parseJSON($("#custom_fields_rules").val());t.on("click",'button, .page-content-wrapper .page-content form [type="submit"]',function(e){e.preventDefault();var t=$(this);Utility.showLoading(),init_options(),$("#nestable-output").val(JSON.stringify(my_custom_json_output($(".nestable-group > .add-new-field > .sortable-wrapper > li"),!0))),get_rules_json(),t.closest("form").submit()})});